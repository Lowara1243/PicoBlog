# PicoBlog

[English](README.md) | **Русский**

PicoBlog — это легкая и производительная платформа для блогов, разработанная как альтернатива WriteFreely, с акцентом на простоту и эффективность, особенно для развертывания на таких устройствах, как Raspberry Pi.

## Возможности

*   **Управление пользователями:** Регистрация пользователей и назначение ролей только администратором.
*   **Контроль доступа:** Администраторы могут назначать пользователям теги для контроля доступа к записям в блоге.
*   **Управление тегами:** Администраторы могут создавать, редактировать и удалять теги.
*   **Управление постами:** Администраторы могут создавать, редактировать и удалять записи в блоге с поддержкой Markdown.
*   **Рендеринг Markdown:** Содержимое записей блога пишется на Markdown и рендерится в HTML для отображения.
*   **Минималистичный дизайн:** Чистый и простой пользовательский интерфейс, стилизованный с помощью Tailwind CSS (скомпилированный, без CDN).
*   **Кнопка копирования:** Копирование блоков кода в один клик.
*   **RSS-лента:** Стандартная лента RSS 2.0 для публичных постов.
*   **Темный режим:** Поддержка темного режима без использования JavaScript с сохранением в cookies.

## Контроль доступа на основе тегов

PicoBlog реализует усовершенствованную систему контроля доступа на основе тегов:

1.  **Публичный или приватный доступ:** Управляется переменной окружения `REQUIRE_LOGIN`.
    *   `REQUIRE_LOGIN=True` (по умолчанию): Только вошедшие в систему (аутентифицированные) пользователи могут видеть любые посты.
    *   `REQUIRE_LOGIN=False`: Посты без каких-либо тегов видны всем (включая анонимных гостей).

2.  **Защищенные посты (требуются теги):** Любой пост хотя бы с одним тегом всегда требует аутентификации и специальных разрешений.

3.  **Посты с обычными тегами (логика «ИЛИ»):**
    *   Если у поста есть *только* обычные теги (т. е. нет мастер-тегов), аутентифицированный пользователь может его просмотреть, если ему назначен *хотя бы один* из тегов, примененных к этому посту.
    *   Это работает как условие «ИЛИ»: наличие `Тега А` ИЛИ `Тега Б` предоставляет доступ, если у поста есть `Тег А` и `Тег Б`.

4.  **Посты с мастер-тегами (логика «И»):**
    *   Некоторые теги могут быть обозначены как «Мастер-теги» (настраивается с помощью `is_master=True` в панели администратора). Эти теги обеспечивают более строгий доступ.
    *   Если у поста есть *какие-либо* мастер-теги, аутентифицированный пользователь должен обладать *всеми* мастер-тегами, примененными к этому посту, чтобы получить доступ.
    *   Это работает как условие «И»: наличие `Мастер-тега X` И `Мастер-тега Y` предоставляет доступ, если у поста есть `Мастер-тег X` и `Мастер-тег Y`.

5.  **Посты со смешанными тегами (логика «И» для мастер-тегов и «ИЛИ» для обычных):**
    *   Если у поста есть *и* мастер-теги, *и* обычные теги, аутентифицированный пользователь должен удовлетворять *обоим* условиям:
        *   Обладать *всеми* мастер-тегами, примененными к посту (логика «И»).
        *   Обладать *хотя бы одним* из обычных тегов, примененных к посту (логика «ИЛИ»).
    *   Невыполнение любого из этих условий приведет к отказу в доступе.

Эта система обеспечивает гранулированный контроль над видимостью контента, позволяя как широкий доступ к общим темам, так и ограниченный доступ к конфиденциальным материалам.

## Установка (Linux)

Следуйте этим инструкциям, чтобы настроить и запустить PicoBlog в системе Linux.

### Предварительные условия

*   **Python 3.10+:** Убедитесь, что у вас установлен Python 3.10 или более поздней версии.
*   **uv:** Быстрый установщик пакетов Python. Если у вас его нет, вы можете установить его с помощью `pip install uv`.
*   **Node.js 16+:** Требуется для сборки Tailwind CSS. Установите с сайта [nodejs.org](https://nodejs.org).

### 1. Клонирование репозитория

```bash
git clone https://github.com/Lowara1243/PicoBlog.git
cd PicoBlog
```

### 2. Настройка виртуального окружения и установка зависимостей Python

Настоятельно рекомендуется использовать виртуальное окружение для управления зависимостями проекта.

```bash
uv venv
source .venv/bin/activate
uv sync
```

> [!TIP]
> **Для пользователей Termux (Android):** Чтобы установить зависимости для обработки изображений на ARM, используйте:
> `pkg install python-pillow`
> или предварительно установите системные библиотеки: `pkg install libjpeg-turbo libpng libwebp`

### 3. Установка зависимостей Node.js и сборка CSS

PicoBlog использует Tailwind CSS, который необходимо скомпилировать.

```bash
npm install
npm run build:css
```

Для разработки с автоматической пересборкой CSS:
```bash
npm run watch:css
```

### 4. Переменные окружения

Создайте файл `.env` в корневом каталоге проекта на основе `.env.example` и введите свой секретный ключ и URL базы данных. Для разработки вы можете использовать значения по умолчанию.

```bash
cp .env.example .env
# Откройте .env в редакторе и измените при необходимости
```

### 5. Настройка базы данных

Примените миграции базы данных, чтобы настроить схему.

```bash
export FLASK_APP=app
flask db upgrade
```

### 6. Создание пользователя-администратора

Для доступа к панели администратора и управления пользователями, тегами и постами требуется пользователь-администратор. Вы можете создать его с помощью Flask shell.

```bash
export FLASK_APP=app
flask shell
```

Внутри Flask shell выполните следующие команды:

```python
from app import db
from app.models import User

admin_user = User.query.filter_by(username='admin').first()
if admin_user is None:
    admin_user = User(username='admin', email='admin@example.com', is_admin=True)
    admin_user.set_password(r'adminpassword') # ВАЖНО: Замените это на надежный, уникальный пароль!
    db.session.add(admin_user)
    db.session.commit()
    print('Админ создан.')
else:
    print('Админ уже существует.')
exit()
```

### 7. Запуск приложения

```bash
export FLASK_APP=app
flask run
```

Приложение обычно запускается по адресу `http://127.0.0.1:5000/`.

## Доступ к панели администратора

1.  Перейдите по адресу `http://127.0.0.1:5000/login` и войдите в систему с учетными данными администратора, которые вы создали.
2.  После входа в систему вы увидите ссылку «Admin» в навигационной панели. Нажмите на нее, чтобы перейти в панель управления администратора.
3.  В панели администратора вы можете управлять пользователями, тегами и постами.

## Административные задачи через Flask Shell

Некоторые критически важные административные задачи могут быть выполнены только через Flask shell по соображениям безопасности. Ниже приведены распространенные сценарии.

### Сброс пароля пользователя

Если пользователь забыл свой пароль или вам нужно его сбросить:

```bash
export FLASK_APP=app
flask shell
```

```python
from app import db
from app.models import User

# Найти пользователя по имени
user = User.query.filter_by(username='username_here').first()

if user:
    user.set_password(r'new_secure_password')
    db.session.commit()
    print(f'Пароль для {user.username} был сброшен.')
else:
    print('Пользователь не найден.')

exit()
```

### Смена администратора

Чтобы передать права администратора другому пользователю или заменить текущего администратора:

```bash
export FLASK_APP=app
flask shell
```

```python
from app import db
from app.models import User

# Лишить текущего администратора прав администратора
old_admin = User.query.filter_by(username='old_admin_username').first()
if old_admin:
    old_admin.is_admin = False
    print(f'Права администратора удалены у {old_admin.username}')

# Предоставить права администратора новому пользователю
new_admin = User.query.filter_by(username='new_admin_username').first()
if new_admin:
    new_admin.is_admin = True
    print(f'Права администратора предоставлены {new_admin.username}')

db.session.commit()
exit()
```

**Примечание:** Статус администратора не может быть изменен через веб-интерфейс. В целях безопасности и простоты рекомендуется иметь только одного администратора.

### Полный сброс базы данных

**ВНИМАНИЕ:** Это удалит ВСЕ данные, включая пользователей, посты, теги и комментарии. Используйте с особой осторожностью!

```bash
# Остановите приложение, если оно запущено

# Удалите файл базы данных
rm data/app.db

# Удалите загруженные файлы (опционально)
rm -rf app/static/uploads/*

# Повторно создайте схему базы данных
export FLASK_APP=app
flask db upgrade

# Создайте нового пользователя-администратора (см. шаг 6 в инструкциях по установке)
flask shell
```

```python
from app import db
from app.models import User

admin = User(username='admin', email='admin@example.com', is_admin=True)
admin.set_password(r'your_secure_password')
db.session.add(admin)
db.session.commit()
print('Сброс базы данных завершен. Новый администратор создан.')
exit()
```

После сброса перезапустите приложение.

Подробные инструкции по развертыванию (Nginx, Gunicorn, systemd) см. в **[docs/RU/DEPLOYMENT.md](docs/RU/DEPLOYMENT.md)**.

---

Дополнительная техническая информация:
- [Спецификации](docs/RU/specifications.md)
- [Руководство по развертыванию](docs/RU/DEPLOYMENT.md)
